---
- name: Add remote users
  user:
    name="{{ item.name}} "
    password="{{ item.password_hashed }}"
  with_items:
  - "{{ users }}"
  when: users != []
  tags:
  - bootstrap
  - credentials
  - setup

- name: Add SSH public key to user remote
  authorized_key:
    user=remote
    key="{{ lookup('file', "../files/workstation.pub") }}"

- name: Add user remote to sudoers
  lineinfile:
    "dest=/etc/sudoers
    regexp='^remote ALL'
    line='remote ALL=(ALL) NOPASSWD: ALL'
    state=present"

- name: Disallow root SSH access
  lineinfile:
    dest=/etc/ssh/sshd_config
    regexp="^PermitRootLogin"
    line="PermitRootLogin no"
    state=present
  notify:
    - restart sshd

- name: Disallow SSH password authentication
  lineinfile:
    dest=/etc/ssh/sshd_config
    regexp="^PasswordAuthentication"
    line="PasswordAuthentication no"
    state=present
  notify:
    - restart sshd

- name: Disallow SSH GSS API authentication
  lineinfile:
    dest=/etc/ssh/sshd_config
    regexp="^GSSAPIAuthentication"
    line="GSSAPIAuthentication no"
    state=present
  notify:
    - restart sshd
